SELECT A.*
FROM CDP.SF_CDPDW.F_LOG_GA_HIST A
JOIN (
    SELECT DISTINCT SESS_ID
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
    WHERE STLM_STP = 4
        AND SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
) B
ON A.SESS_ID = B.SESS_ID
WHERE A.STND_YMD BETWEEN '2024-01-01' AND '2024-03-31'
    AND A.SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
LIMIT 2000;


WITH SESS_IDS AS (
    SELECT DISTINCT SESS_ID
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
    WHERE STLM_STP = 4
        AND SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
)
SELECT A.*
FROM CDP.SF_CDPDW.F_LOG_GA_HIST A
JOIN SESS_IDS B
ON A.SESS_ID = B.SESS_ID
WHERE A.STND_YMD BETWEEN '2024-01-01' AND '2024-03-31'
    AND A.SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
LIMIT 2000;


WITH COMMON_PRODUCTS AS (
    -- 동시에 판매 중인 상품(두 개 사이트에서 PRD_CD가 공통으로 존재하는 경우)
    SELECT PRD_CD
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
    WHERE SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
    GROUP BY PRD_CD
    HAVING COUNT(DISTINCT SITE_ID) = 2
),
SESSIONS_WITH_COMMON_PRODUCTS AS (
    -- 위에서 추출한 상품을 구매한 SESS_ID 목록 추출
    SELECT DISTINCT SESS_ID
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
    WHERE PRD_CD IN (SELECT PRD_CD FROM COMMON_PRODUCTS)
      AND STLM_STP = 4  -- 구매 완료 세션
      AND SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
)
SELECT A.*
FROM CDP.SF_CDPDW.F_LOG_GA_HIST A
JOIN SESSIONS_WITH_COMMON_PRODUCTS B
ON A.SESS_ID = B.SESS_ID
WHERE A.STND_YMD BETWEEN '2024-01-01' AND '2024-03-31'
    AND A.SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
LIMIT 2000;
