-- INCS_NO 빈 값 채우기
WITH NEW_INCS_GA AS (
    SELECT  *
          , COALESCE(INCS_NO, MAX(INCS_NO) OVER (PARTITION BY SESS_ID, GOOGLE_CID)) AS NEW_INCS_NO
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
WHERE SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
      AND STND_YMD BETWEEN '2024-02-01' AND '2024-03-31'
)
-- 조회할 로그 정보
, LOGS AS (
    SELECT LOG_DTTM, WEB_APP_CL_CD, GOOGLE_CID, SESS_ID, INCS_NO, EMP_YN, AGE, SEX_CD, CUST_GRD_NM, PG_NM, PG_TP_VL, ACCM_STAY_TIME_NSS, PG_STAY_TIME, SESS_SN_STAY_TIME
           , SESS_SN, EVNT_NM, EVNT_ACTN, EVNT_LABEL, NEW_INCS_NO, ROW_NUMBER() OVER (PARTITION BY SESS_ID ORDER BY LOG_DTTM ASC) AS LOG_ORDER
           , SUM(SESS_SN_STAY_TIME) OVER (PARTITION BY SESS_ID, NEW_INCS_NO) AS SESS_STAY_TIME
    FROM NEW_INCS_GA
    WHERE EVNT_NM IN ('Scroll', 'product', 'checkout1', 'checkout2', 'checkot3', 'checkout4', 'addToCart', 'purchase')
    ORDER BY LOG_DTTM, SESS_ID, NEW_INCS_NO, LOG_ORDER
)
-- 분석에 사용할 퍼널 정보
SELECT *
FROM LOGS;
