# 동시 판매 상품 찾기
WITH PRODUCTS AS (
    SELECT PRD_CD
    FROM CDP.SF_CDPDW.D_CHN_PRD_MSTR
    WHERE (CHN_CD = '036' OR (CHN_CD = '031' AND CHN_BRND_NM = 'INNISFREE'))
        AND PRD_CD != 'Z'
    GROUP BY PRD_CD
    HAVING COUNT(DISTINCT CHN_CD) = 2  -- 두 개의 CHN_CD에서 모두 존재하는 상품만 선택
)
SELECT *
FROM CDP.SF_CDPDW.D_CHN_PRD_MSTR
WHERE PRD_CD IN (SELECT PRD_CD FROM PRODUCTS)
    AND (CHN_CD = '036' OR (CHN_CD = '031' AND CHN_BRND_NM = 'INNISFREE'))
    AND PRD_CD != 'Z';


# 상품 구매 세션 로그 추출
WITH PRODUCTS AS (
    -- 동시 판매되는 상품(PRD_CD) 목록 추출
    SELECT PRD_CD
    FROM CDP.SF_CDPDW.D_CHN_PRD_MSTR
    WHERE (SITE_ID = 'UA-110770460-3' OR (SITE_ID = 'UA-110770460-1' AND CHN_BRND_NM = 'INNISFREE'))
        AND PRD_CD != 'Z'
    GROUP BY PRD_CD
    HAVING COUNT(DISTINCT SITE_ID) = 2  -- 두 개의 SITE_ID에서 모두 존재하는 경우만 선택
),
VALID_SESSIONS AS (
    -- 구매 완료된 세션(STLM_STP = 4) & 동시 판매 상품을 구매한 세션만 필터링
    SELECT DISTINCT SESS_ID
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
    WHERE STLM_STP = 4  -- 구매 완료 세션만 선택
      AND SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')  -- 사이트 필터링
      AND JSON_VALUE(PRD_INFO, '$.PRD_CD') IN (SELECT PRD_CD FROM PRODUCTS)  -- PRD_INFO에서 JSON으로 prd_cd 추출
)
-- 최종적으로 해당 세션들의 전체 로그를 조회
SELECT A.*
FROM CDP.SF_CDPDW.F_LOG_GA_HIST A
JOIN VALID_SESSIONS B
ON A.SESS_ID = B.SESS_ID
WHERE A.STND_YMD BETWEEN '2024-01-01' AND '2024-03-31'
  AND A.SITE_ID IN ('UA-110770460-3', 'UA-110770460-1');
