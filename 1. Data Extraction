-- -- 동시 판매 상품 코드 찾기
WITH PRODUCTS AS (
    SELECT PRD_CD
    FROM CDP.SF_CDPDW.D_CHN_PRD_MSTR
    WHERE (CHN_CD = '036' OR (CHN_CD = '031' AND CHN_BRND_NM = 'INNISFREE'))
        AND PRD_CD != 'Z'
    GROUP BY PRD_CD
    HAVING COUNT(DISTINCT CHN_CD) = 2  -- 두 개의 CHN_CD에서 모두 존재하는 상품만 선택
)
-- 주문 완료한 고객 세션 찾기
,ORDER_CUSTS AS (
    SELECT *
    FROM CDP.SF_CDPDW.F_LOG_GA_STLM_PRD_HIST 
    WHERE SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
          AND STND_YMD BETWEEN '2024-02-01' AND '2024-03-31'
          AND PRD_CD IN (SELECT PRD_CD FROM PRODUCTS)
)
-- INCS_NO 빈 값 채워주기
, NEW_INCS_GA AS (
    SELECT  *
          , COALESCE(INCS_NO, MAX(INCS_NO) OVER (PARTITION BY SESS_ID, GOOGLE_CID)) AS NEW_INCS_NO
    FROM CDP.SF_CDPDW.F_LOG_GA_HIST
WHERE SESS_ID IN (SELECT SESS_ID FROM ORDER_CUSTS)
      AND SITE_ID IN ('UA-110770460-3', 'UA-110770460-1')
      AND STND_YMD BETWEEN '2024-02-01' AND '2024-03-31'
)
-- 조회할 로그 정보
, LOGS AS (
SELECT LOG_DTTM, WEB_APP_CL_CD, GOOGLE_CID, SESS_ID, INCS_NO, EMP_YN, AGE, SEX_CD, CUST_GRD_NM, PG_NM, PG_TP_VL, ACCM_STAY_TIME_NSS, PG_STAY_TIME, SESS_SN_STAY_TIME
       , SESS_SN, EVNT_NM, EVNT_ACTN, EVNT_LABEL, NEW_INCS_NO, ROW_NUMBER() OVER (PARTITION BY SESS_ID ORDER BY LOG_DTTM ASC) AS LOG_ORDER
       , SUM(SESS_SN_STAY_TIME) OVER (PARTITION BY SESS_ID, NEW_INCS_NO) AS SESS_STAY_TIME
FROM NEW_INCS_GA
)
SELECT L.*, ORD.PRD_CD, ORD.POS_NET_PRD_SAL_AMT
FROM LOGS L LEFT JOIN ORDER_CUSTS ORD ON (L.SESS_ID = ORD.SESS_ID) AND (L.NEW_INCS_NO = ORD.INCS_NO) AND (L.GOOGLE_CID = ORD.GOOGLE_CID)
ORDER BY LOG_DTTM, SESS_ID, NEW_INCS_NO, LOG_ORDER
